# SmoothOperator: Reducing Power Fragmentation and Improving Power Utilization in Large-scale Datacenters

2018 ASPLOS

数据中心的服务器数量收电力基础设施容量的限制。文中首先调查了Facebook数据中心的电力利用情况。

We observe that the combination of **provisioning for peak power usage,** **highly fluctuating traffic, and multi-level power delivery infrastructure** leads to significant power budget fragmentation problem and inefficiently low power utilization.

三者结合导致显著的电力预算碎片化问题和低效率的电力利用

- 为高峰电力使用的配置
- 高度波动的流量
- 多级电力传输基础设施

通过重新分配服务来重新塑造每个电源节点的功率曲线，将具有异步峰值时间的服务组合在同一电源节点下，**减少每个节点的峰值功率，从而创造更多的电源余量**，允许托管更多的服务器，实现更高的吞吐量。基于此，文章开发了一个**工作负载感知的服务放置框架**，用动态功率曲线重塑，最大限度地利用其框架所释放的空间。

**研究背景**

数据中心上的服务器数量往往受其电力预算限制，建设新的数据中心和电网可以解决这一问题但是成本高且耗时长，因此数据中心需要最大化利用现有的电力基础设施。

Facebook生产型数据中心的电力供应存在**两大挑战**

- 挑战1，峰值配置倒是电力预算利用率低，因为峰值供应的其他时间里电力预算没有被高度使用。

- 挑战2，**多级电力传输基础设施导致电力预算碎片化**。**服务实例如何被置于叶子电源节点之下会影响电力预算的利用率。**电力传输设施的结构是树状的，电源节点的分层结构提高了电力基础设施的可靠性，但是这也导致电源预算利用率低，因为峰值供应发生在所有级别的电源节点上。同步耗电模型的服务器连接到同一个叶节点会导致在叶节点产生高振幅的快速峰值，迅速消耗了本地的功率预算。（如图1中的上方图片所示）。在第二类数据中心中，具有同步耗电模式的服务实例被分散开来。文章指出，**当仔细分散同步服务实例时，叶子电源节点的快速峰值被消除**，叶子节点的电源净空被增加。这些增加的本地电源净空允许提供更多的服务器，**这提高了电源预算的利用率和整个数据中心的效率。**

  - 电力预算碎片化，将具有同步电力消耗模式的服务实例放置一起导致迅速峰值，降低了整体的功率预算利用率，见论文 Fig.3

    ![image-20230411203236488](C:\Users\苏铄淼\Desktop\论文笔记\17-1.png)

  - 电力预算碎片化程度和电力预算利用的低效率指标：Sum of peaks 、Power slack and engery slack。电力峰值之和与电力松弛和能源松弛（电力松弛之和，越小越好）



**研究问题**

当前研究不足以解决上述问题，针对挑战1，当前的解决方案将相同服务的实例通常放在一个叶节点上考虑，由于这些实例在同一时间达到峰值，提供这些延迟关键型服务器的相应叶子节点比其他叶子节点更快地消耗其电源预算，而其他有空余功率雨量的叶子节点却无法被使用。针对挑战2，当前方案要么需要修改电源基础设施，要么其电池容量无法长期处理数小时的Facebook类型的工作负载。因此，**如何在不改变现有电力基础设施的情况下实现更高的吞吐量，提高数据中心的电力使用效率**，是一个亟待解决的问题。





**研究方法**

为解决上述问题，文章提出SmoothOperator，分析电力消耗模式的时间异质性并得出高功率效率服务安置的框架。SmoothOperator利用一种新的方法对不同服务之间的时间异质性进行系统化建模和评分。在分析的基础上，SmoothOperator使用**基于聚类**的方法以识别会同时产生高峰值的实例，并把它们分散到整个数据中心。

该框架增加了各级电力传输基础设施的功率余量，允许托管更多的服务器并提高数据中心的吞吐量。同时，文章也观察到，**简单地增加服务器并不能提高资源利用率**。文章利用最近在生产中部署的一种新型的分离服务器，将计算和存储组件解耦，设计了一套基于历史的服务器转换和主动的节流和提升策略，以充分利用新增加的服务器，进一步提高资源和电力利用率。

论文的主要框架如下：

- 确定了生产型数据中心中的电力预算碎片化问题

- 提出基于工作负载感知的服务实例放置和重映射框架，利用以往在高层次功率节点上浪费的功率预算以缓解（mitigate）功率预算碎片化问题
  - mitigate：make bad things less severe,serious or painful
  - 收集跟踪和提取代表性的跟踪。对于主要的服务，每个服务团队在一组单独的物理服务器上管理自己的服务，不同的主要服务不共享物理服务器。一个服务是数百到数千个服务实例的集合。这些服务实例中的每一个都是运行服务副本或服务的一部分的进程。
  - 计算异步分数
  - 聚类
  - 服务实例部署
- 适应工作负载的变化（考虑中长期的工作负载变化，瞬时工作负载变化由功率封顶方案确定）——选择具有最低差分异步分数的服务实例，并将其与来自另一个电源节点的其他服务实例交换，当且仅当该交换使所涉及的两个电源节点的差分异步分数更高。
  
- 为进一步利用额外的功率空间，文章采用存储分离的服务器，并设计了动态功率曲线重塑技术来提高吞吐量——通过动态电力分布重塑利用电力预算，**进一步探索通过仔细利用额外的服务器来实现额外吞吐量增加的机会**

  - 基于历史的服务器转换 

    存储分离服务器转换（①存储分离服务器允许我们通过只托管LC服务来适应高峰期增加的LC流量，并在非高峰期提高Batch的吞吐量、②能够在保持数据可用性的同时，保持更好的整体资源利用率、③服务器转换过程开销低，不需要耗时的数据迁移）

  - 基于历史的主动节流和提升

    如何在 LC-heavy 和 batch-heavy 阶段进行切换

这样的负载分担导致在一小部分电源节点上出现高峰值聚集的概率降低，因此减少了某些重载电源节点内断路器跳闸的可能性。



**研究结论**

SmoothOperator 的工作负载感知服务实例放置框架降低了不同功率节点级别的峰值功率，缓解了功率预算碎片化问题，并允许数据中心运营商在相同的条件下托管更多服务器功率预算。通过 SmoothOperator 的动态功率分布重塑策略，实验提高了非高峰时段的功率利用率，从而进一步提高了服务吞吐量。